name: Deploy to VPS

# üîÑ –≠—Ç–æ—Ç workflow –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—É—à–µ –≤ –≤–µ—Ç–∫—É dev
on:
  push:
    branches:
      - dev

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest  # GitHub –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–∞ Ubuntu runner

    steps:
      # üì¶ –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ runner
      - name: Checkout code
        uses: actions/checkout@v3

      # üîê –®–∞–≥ 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç SSH-–∫–ª—é—á –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ VPS
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}  # –ö–ª—é—á –∏–∑ Secrets

      # üöÄ –®–∞–≥ 3: –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ VPS, –¥–µ–ª–∞–µ—Ç git pull –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç Docker
      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.VPS_IP }} << EOF
            cd ~/eSIM_new  # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            git reset --hard  # –û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –±—ã–ª–∏)
            git pull origin dev  # –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏–∑ –≤–µ—Ç–∫–∏ dev
            docker-compose down  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            # docker-compose up -d --build  # –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
            docker-compose up -d --build --force-recreate  # (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π)
          EOF
